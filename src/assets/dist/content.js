(()=>{"use strict";let i=Garnish.Base.extend({emailId:null,langId:null,isActive:!1,$editor:null,$spinner:null,$shade:null,$editorContainer:null,$previewContainer:null,$iframeContainer:null,$results:null,_editorWidth:null,_editorWidthInPx:null,defaultEditorWidth:.33,minEditorWidthInPx:320,init:function(i){this.langId=i.langId,this.emailId=i.emailId,this.editorWidth=this.defaultEditorWidth},get editorWidth(){return this._editorWidth},get editorWidthInPx(){return this._editorWidthInPx},set editorWidth(i){var t;i>=1?(t=i,i/=Garnish.$win.width()):t=Math.round(i*Garnish.$win.width()),t<this.minEditorWidthInPx&&(i=(t=this.minEditorWidthInPx)/Garnish.$win.width()),this._editorWidth=i,this._editorWidthInPx=t},open:function(){if(!this.isActive){if(this.isActive=!0,$(document.activeElement).trigger("blur"),!this.$editor){this.$shade=$("<div/>",{class:"modal-shade dark"}).appendTo(Garnish.$bod),this.$previewContainer=$("<div/>",{class:"lp-preview-container"}).appendTo(Garnish.$bod),this.$editorContainer=$("<div/>",{class:"lp-editor-container"}).appendTo(Garnish.$bod);var i=$("<header/>",{class:"flex"}).appendTo(this.$editorContainer);this.$editor=$("<form/>",{class:"lp-editor"}).appendTo(this.$editorContainer);var t=$("<button/>",{type:"button",class:"btn",text:Craft.t("app","Close Preview")}).appendTo(i),e=$("<button/>",{type:"button",class:"btn",text:Craft.t("app","Refresh")}).appendTo(i);$("<div/>",{class:"flex-grow"}).appendTo(i),this.$spinner=$("<div/>",{class:"spinner hidden",title:Craft.t("app","Saving")}).appendTo(i),this.$iframeContainer=$("<div/>",{class:"lp-iframe-container"}).appendTo(this.$previewContainer),this.addListener(t,"click","close"),this.addListener(e,"click",(()=>{this.updateIframe()}))}this.updateWidths(),this.addListener(Garnish.$win,"resize","updateWidths"),this.$editorContainer.css(Craft.left,-this.editorWidthInPx+"px"),this.$previewContainer.css(Craft.right,-this.getIframeWidth()),$("#content").find(">*").appendTo(this.$editor),this.updateIframe(),this.slideIn()}},close:function(){this.isActive&&this.isVisible&&($("html").removeClass("noscroll"),this.removeListener(Garnish.$win,"resize"),this.removeListener(Garnish.$bod,"keyup"),this.$editor.find(">*").appendTo($("#content")),this.$shade.delay(200).velocity("fadeOut"),this.$editorContainer.velocity("stop").animateLeft(-this.editorWidthInPx,"slow",(()=>{this.$editorContainer.hide(),this.trigger("slideOut")})),this.$previewContainer.velocity("stop").animateRight(-this.getIframeWidth(),"slow",(()=>{this.$previewContainer.hide()})),this.isActive=!1,this.isVisible=!1)},updateWidths:function(){this.editorWidth=this.editorWidth,this.$editorContainer.css("width",this.editorWidthInPx+"px"),this.$previewContainer.width(this.getIframeWidth())},_updateRefreshBtn:function(){this.$refreshBtn.removeClass("hidden")},getIframeWidth:function(){return Garnish.$win.width()-this.editorWidthInPx},updateIframe:function(){if(!this.isActive)return!1;var i=Craft.getUrl("emails/preview/"+this.emailId+"/"+this.langId),t={subject:$("#field-subject").val(),body:$("#field-body-field .redactor-in").html()};$("#field-body-field .redactor-in").length||(t.body=$("#body").val()),this.$iframeContainer.html(""),axios.post(i,t).then((i=>{i.data.subjectError&&this.$iframeContainer.append('<div class="warning-banner">'+i.data.subjectError),i.data.bodyError&&this.$iframeContainer.append('<div class="warning-banner">'+i.data.bodyError);var t=$('<div id="email-preview">');this.$iframeContainer.append(t),t.append("<label>"+Craft.t("emails","Subject")+'</label>                <div class="subject">                    '+i.data.subject+"                </div>"),t.append("<label>"+Craft.t("emails","Body")+"</label>");let e=$('<div class="iframe-wrapper">');t.append(e);let n=$("<iframe/>",{frameborder:0});e.append(n),n[0].contentWindow.document.open(),n[0].contentWindow.document.write(i.data.body),n[0].contentWindow.document.close()})).catch((i=>{console.log(i);let t=i.response.data.error;this.$iframeContainer.append('<div class="error-banner">Error while fetching preview : '+t)}))},slideIn:function(){this.isActive&&!this.isVisible&&($("html").addClass("noscroll"),this.$shade.velocity("fadeIn"),this.$editorContainer.show().velocity("stop").animateLeft(0,"slow",(()=>{this.trigger("slideIn"),Garnish.$win.trigger("resize")})),this.$previewContainer.show().velocity("stop").animateRight(0,"slow",(()=>{this.addListener(Garnish.$bod,"keyup",(function(i){i.keyCode===Garnish.ESC_KEY&&this.close()}))})),this.isVisible=!0)}});Craft.Emails.EmailContent=Garnish.Base.extend({jsSettings:null,livePreview:null,langId:null,email:null,init:function(i){this.langId=i.langId,this.jsSettings=i.jsSettings,this.email=i.email,this.initLivePreview(),this.initAddTranslation(),this.initDelete(),new Craft.AssetSelectInput(this.jsSettings)},initLivePreview:function(){this.livePreview=new i({langId:this.langId,emailId:this.email.id}),$(".js-preview").click((()=>{this.livePreview.open()}))},initAddTranslation:function(){$(".js-add-translation").click((function(i){i.preventDefault();let t=$(this).attr("href");$.ajax({url:Craft.getActionUrl("emails/cp-emails/add-translation"),data:{localeId:$(this).data("locale"),key:this.email.key},dataType:"json"}).fail((function(i){Craft.Emails.handleError(i)})).done((function(i){window.location.href=t}))}))},initDelete:function(){$(".js-delete").click((i=>{if(i.preventDefault(),confirm(Craft.t("emails","Are you sure you want to delete this translation?"))){let t=$(i.target).attr("href");$.ajax({url:Craft.getActionUrl("emails/cp-emails/delete-translation"),data:{localeId:$(i.target).data("locale"),key:this.email.key},dataType:"json"}).fail((function(i){Craft.Emails.handleError(i)})).done((function(i){window.location.href=t}))}}))}})})();